<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2017-02-08 23:53:14 +0100">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="/swc-releases/2017.02/sql-novice-survey">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Databases and SQL: Aggregation</title>
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li><a href="../reference/">Reference</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-select/">Selecting Data</a></li>
            
            <li><a href="../02-sort-dup/">Sorting and Removing Duplicates</a></li>
            
            <li><a href="../03-filter/">Filtering</a></li>
            
            <li><a href="../04-calc/">Calculating New Values</a></li>
            
            <li><a href="../05-null/">Missing Data</a></li>
            
            <li><a href="../06-agg/">Aggregation</a></li>
            
            <li><a href="../07-join/">Combining Data</a></li>
            
            <li><a href="../08-hygiene/">Data Hygiene</a></li>
            
            <li><a href="../09-create/">Creating and Modifying Data</a></li>
            
            <li><a href="../10-prog/">Programming with Databases - Python</a></li>
            
            <li><a href="../11-prog-R/">Programming with Databases - R</a></li>
            
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../about/">About</a></li>
            
            <li><a href="../discuss/">Discussion</a></li>
            
            <li><a href="../figures/">Figures</a></li>
            
            <li><a href="../guide/">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../05-null/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">Databases and SQL</a></h3>
    <h1 class="maintitle">Aggregation</h1>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../07-join/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 10 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How can I calculate sums, averages, and other summary values?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Define aggregation and give examples of its use.</p>
</li>
	
	<li><p>Write queries that compute aggregated values.</p>
</li>
	
	<li><p>Trace the execution of a query that performs aggregation.</p>
</li>
	
	<li><p>Explain how missing data is handled during aggregation.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>We now want to calculate ranges and averages for our data.
We know how to select all of the dates from the <code class="highlighter-rouge">Visited</code> table:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT dated FROM Visited;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>dated</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1927-02-08</td>
    </tr>
    <tr>
      <td>1927-02-10</td>
    </tr>
    <tr>
      <td>1930-01-07</td>
    </tr>
    <tr>
      <td>1930-01-12</td>
    </tr>
    <tr>
      <td>1930-02-26</td>
    </tr>
    <tr>
      <td>-null-</td>
    </tr>
    <tr>
      <td>1932-01-14</td>
    </tr>
    <tr>
      <td>1932-03-22</td>
    </tr>
  </tbody>
</table>

<p>but to combine them,
we must use an <a href="/swc-releases/2017.02/sql-novice-survey/reference/#aggregation-function">aggregation function</a>
such as <code class="highlighter-rouge">min</code> or <code class="highlighter-rouge">max</code>.
Each of these functions takes a set of records as input,
and produces a single record as output:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT min(dated) FROM Visited;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>min(dated)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1927-02-08</td>
    </tr>
  </tbody>
</table>

<p><img src="../fig/sql-aggregation.svg" alt="SQL Aggregation" /></p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT max(dated) FROM Visited;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>max(dated)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1932-03-22</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">min</code> and <code class="highlighter-rouge">max</code> are just two of
the aggregation functions built into SQL.
Three others are <code class="highlighter-rouge">avg</code>,
<code class="highlighter-rouge">count</code>,
and <code class="highlighter-rouge">sum</code>:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT avg(reading) FROM Survey WHERE quant='sal';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>avg(reading)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>7.20333333333333</td>
    </tr>
  </tbody>
</table>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT count(reading) FROM Survey WHERE quant='sal';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>count(reading)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>9</td>
    </tr>
  </tbody>
</table>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT sum(reading) FROM Survey WHERE quant='sal';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>sum(reading)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>64.83</td>
    </tr>
  </tbody>
</table>

<p>We used <code class="highlighter-rouge">count(reading)</code> here,
but we could just as easily have counted <code class="highlighter-rouge">quant</code>
or any other field in the table,
or even used <code class="highlighter-rouge">count(*)</code>,
since the function doesn’t care about the values themselves,
just how many values there are.</p>

<p>SQL lets us do several aggregations at once.
We can,
for example,
find the range of sensible salinity measurements:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT min(reading), max(reading) FROM Survey WHERE quant='sal' AND reading&lt;=1.0;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>min(reading)</th>
      <th>max(reading)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.05</td>
      <td>0.21</td>
    </tr>
  </tbody>
</table>

<p>We can also combine aggregated results with raw results,
although the output might surprise you:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT person, count(*) FROM Survey WHERE quant='sal' AND reading&lt;=1.0;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>count(*)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>lake</td>
      <td>7</td>
    </tr>
  </tbody>
</table>

<p>Why does Lake’s name appear rather than Roerich’s or Dyer’s?
The answer is that when it has to aggregate a field,
but isn’t told how to,
the database manager chooses an actual value from the input set.
It might use the first one processed,
the last one,
or something else entirely.</p>

<p>Another important fact is that when there are no values to aggregate —
for example, where there are no rows satisfying the <code class="highlighter-rouge">WHERE</code> clause —
aggregation’s result is “don’t know”
rather than zero or some other arbitrary value:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT person, max(reading), sum(reading) FROM Survey WHERE quant='missing';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>max(reading)</th>
      <th>sum(reading)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-null-</td>
      <td>-null-</td>
      <td>-null-</td>
    </tr>
  </tbody>
</table>

<p>One final important feature of aggregation functions is that
they are inconsistent with the rest of SQL in a very useful way.
If we add two values,
and one of them is null,
the result is null.
By extension,
if we use <code class="highlighter-rouge">sum</code> to add all the values in a set,
and any of those values are null,
the result should also be null.
It’s much more useful,
though,
for aggregation functions to ignore null values
and only combine those that are non-null.
This behavior lets us write our queries as:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT min(dated) FROM Visited;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>min(dated)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1927-02-08</td>
    </tr>
  </tbody>
</table>

<p>instead of always having to filter explicitly:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT min(dated) FROM Visited WHERE dated IS NOT NULL;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>min(dated)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1927-02-08</td>
    </tr>
  </tbody>
</table>

<p>Aggregating all records at once doesn’t always make sense.
For example,
suppose we suspect that there is a systematic bias in our data,
and that some scientists’ radiation readings are higher than others.
We know that this doesn’t work:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT person, count(reading), round(avg(reading), 2)
FROM  Survey
WHERE quant='rad';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>count(reading)</th>
      <th>round(avg(reading), 2)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>roe</td>
      <td>8</td>
      <td>6.56</td>
    </tr>
  </tbody>
</table>

<p>because the database manager selects a single arbitrary scientist’s name
rather than aggregating separately for each scientist.
Since there are only five scientists,
we could write five queries of the form:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT person, count(reading), round(avg(reading), 2)
FROM  Survey
WHERE quant='rad'
AND   person='dyer';
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>count(reading)</th>
      <th>round(avg(reading), 2)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dyer</td>
      <td>2</td>
      <td>8.81</td>
    </tr>
  </tbody>
</table>

<p>but this would be tedious,
and if we ever had a data set with fifty or five hundred scientists,
the chances of us getting all of those queries right is small.</p>

<p>What we need to do is
tell the database manager to aggregate the hours for each scientist separately
using a <code class="highlighter-rouge">GROUP BY</code> clause:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT   person, count(reading), round(avg(reading), 2)
FROM     Survey
WHERE    quant='rad'
GROUP BY person;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>count(reading)</th>
      <th>round(avg(reading), 2)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dyer</td>
      <td>2</td>
      <td>8.81</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>2</td>
      <td>1.82</td>
    </tr>
    <tr>
      <td>pb</td>
      <td>3</td>
      <td>6.66</td>
    </tr>
    <tr>
      <td>roe</td>
      <td>1</td>
      <td>11.25</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">GROUP BY</code> does exactly what its name implies:
groups all the records with the same value for the specified field together
so that aggregation can process each batch separately.
Since all the records in each batch have the same value for <code class="highlighter-rouge">person</code>,
it no longer matters that the database manager
is picking an arbitrary one to display
alongside the aggregated <code class="highlighter-rouge">reading</code> values.</p>

<p>Just as we can sort by multiple criteria at once,
we can also group by multiple criteria.
To get the average reading by scientist and quantity measured,
for example,
we just add another field to the <code class="highlighter-rouge">GROUP BY</code> clause:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT   person, quant, count(reading), round(avg(reading), 2)
FROM     Survey
GROUP BY person, quant;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>quant</th>
      <th>count(reading)</th>
      <th>round(avg(reading), 2)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-null-</td>
      <td>sal</td>
      <td>1</td>
      <td>0.06</td>
    </tr>
    <tr>
      <td>-null-</td>
      <td>temp</td>
      <td>1</td>
      <td>-26.0</td>
    </tr>
    <tr>
      <td>dyer</td>
      <td>rad</td>
      <td>2</td>
      <td>8.81</td>
    </tr>
    <tr>
      <td>dyer</td>
      <td>sal</td>
      <td>2</td>
      <td>0.11</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>rad</td>
      <td>2</td>
      <td>1.82</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>sal</td>
      <td>4</td>
      <td>0.11</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>temp</td>
      <td>1</td>
      <td>-16.0</td>
    </tr>
    <tr>
      <td>pb</td>
      <td>rad</td>
      <td>3</td>
      <td>6.66</td>
    </tr>
    <tr>
      <td>pb</td>
      <td>temp</td>
      <td>2</td>
      <td>-20.0</td>
    </tr>
    <tr>
      <td>roe</td>
      <td>rad</td>
      <td>1</td>
      <td>11.25</td>
    </tr>
    <tr>
      <td>roe</td>
      <td>sal</td>
      <td>2</td>
      <td>32.05</td>
    </tr>
  </tbody>
</table>

<p>Note that we have added <code class="highlighter-rouge">quant</code> to the list of fields displayed,
since the results wouldn’t make much sense otherwise.</p>

<p>Let’s go one step further and remove all the entries
where we don’t know who took the measurement:</p>

<div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT   person, quant, count(reading), round(avg(reading), 2)
FROM     Survey
WHERE    person IS NOT NULL
GROUP BY person, quant
ORDER BY person, quant;
</code></pre>
</div>

<table>
  <thead>
    <tr>
      <th>person</th>
      <th>quant</th>
      <th>count(reading)</th>
      <th>round(avg(reading), 2)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dyer</td>
      <td>rad</td>
      <td>2</td>
      <td>8.81</td>
    </tr>
    <tr>
      <td>dyer</td>
      <td>sal</td>
      <td>2</td>
      <td>0.11</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>rad</td>
      <td>2</td>
      <td>1.82</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>sal</td>
      <td>4</td>
      <td>0.11</td>
    </tr>
    <tr>
      <td>lake</td>
      <td>temp</td>
      <td>1</td>
      <td>-16.0</td>
    </tr>
    <tr>
      <td>pb</td>
      <td>rad</td>
      <td>3</td>
      <td>6.66</td>
    </tr>
    <tr>
      <td>pb</td>
      <td>temp</td>
      <td>2</td>
      <td>-20.0</td>
    </tr>
    <tr>
      <td>roe</td>
      <td>rad</td>
      <td>1</td>
      <td>11.25</td>
    </tr>
    <tr>
      <td>roe</td>
      <td>sal</td>
      <td>2</td>
      <td>32.05</td>
    </tr>
  </tbody>
</table>

<p>Looking more closely,
this query:</p>

<ol>
  <li>
    <p>selected records from the <code class="highlighter-rouge">Survey</code> table
where the <code class="highlighter-rouge">person</code> field was not null;</p>
  </li>
  <li>
    <p>grouped those records into subsets
so that the <code class="highlighter-rouge">person</code> and <code class="highlighter-rouge">quant</code> values in each subset
were the same;</p>
  </li>
  <li>
    <p>ordered those subsets first by <code class="highlighter-rouge">person</code>,
and then within each sub-group by <code class="highlighter-rouge">quant</code>;
and</p>
  </li>
  <li>
    <p>counted the number of records in each subset,
calculated the average <code class="highlighter-rouge">reading</code> in each,
and chose a <code class="highlighter-rouge">person</code> and <code class="highlighter-rouge">quant</code> value from each
(it doesn’t matter which ones,
since they’re all equal).</p>
  </li>
</ol>

<blockquote class="challenge">
  <h2 id="counting-temperature-readings">Counting Temperature Readings</h2>

  <p>How many temperature readings did Frank Pabodie record,
and what was their average value?</p>
</blockquote>

<blockquote class="challenge">
  <h2 id="averaging-with-null">Averaging with NULL</h2>

  <p>The average of a set of values is the sum of the values
divided by the number of values.
Does this mean that the <code class="highlighter-rouge">avg</code> function returns 2.0 or 3.0
when given the values 1.0, <code class="highlighter-rouge">null</code>, and 5.0?</p>
</blockquote>

<blockquote class="challenge">
  <h2 id="what-does-this-query-do">What Does This Query Do?</h2>

  <p>We want to calculate the difference between
each individual radiation reading
and the average of all the radiation readings.
We write the query:</p>

  <div class="sql highlighter-rouge"><pre class="highlight"><code>SELECT reading - avg(reading) FROM Survey WHERE quant='rad';
</code></pre>
  </div>

  <p>What does this actually produce, and why?</p>
</blockquote>

<blockquote class="challenge">
  <h2 id="ordering-when-concatenating">Ordering When Concatenating</h2>

  <p>The function <code class="highlighter-rouge">group_concat(field, separator)</code>
concatenates all the values in a field
using the specified separator character
(or ‘,’ if the separator isn’t specified).
Use this to produce a one-line list of scientists’ names,
such as:</p>

  <div class="sql highlighter-rouge"><pre class="highlight"><code>William Dyer, Frank Pabodie, Anderson Lake, Valentina Roerich, Frank Danforth
</code></pre>
  </div>

  <p>Can you find a way to order the list by surname?</p>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Use aggregation functions to combine multiple values.</p>
</li>
    
    <li><p>Aggregation functions ignore <code class="highlighter-rouge">null</code> values.</p>
</li>
    
    <li><p>Aggregation happens after filtering.</p>
</li>
    
    <li><p>Use GROUP BY to combine subsets separately.</p>
</li>
    
    <li><p>If no aggregation function is specified for a field, the query may return an arbitrary value for that field.</p>
</li>
    
  </ul>
</blockquote>





<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../05-null/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../07-join/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      <footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016
	<a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="mailto:lessons@software-carpentry.org">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    <script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
